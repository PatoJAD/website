{{ $data := site.Data.linkedin }}
{{ $techList := .Site.Params.technologies.main }}
<h3 class="text-2xl text-fuchsia-700 font-bold mb-2 background p-4 rounded-xl text-center">
  Experiencia Laboral
</h3>
{{ $count := len $data.positions }}
{{ if gt $count 0 }}
{{ $first := index $data.positions 0 }}
<div class="w-full mb-2">
  <article class="background shadow rounded-xl p-4">
    <div class="flex items-center gap-2">
      <img src="{{ $first.company_logo | default " /img/placeholder-company.png" }}" alt="{{ $first.company }} logo"
        class="h-20 w-20 object-contain rounded-xl background" loading="lazy" decoding="async">
      <div class="w-full">
        <h3 class="text-2xl font-bold text-fuchsia-700">{{ $first.company }}</h3>
        <div class="text-sm text-gray-600 dark:text-gray-300">
          <em class="fa fa-location-pin"></em> {{ $first.location }}
        </div>
        {{ $firstRolesCount := len $first.roles }}
        {{ if gt $firstRolesCount 0 }}
        {{ $monthsNamesCompany := slice "enero" "febrero" "marzo" "abril" "mayo" "junio" "julio" "agosto" "septiembre" "octubre" "noviembre" "diciembre" }}
        {{ $rolesWithStart := where $first.roles "start_date" "!=" "" }}
        {{ $rolesWithEnd := where $first.roles "end_date" "!=" "" }}
        {{ $validEndRoles := slice }}
        {{ range $rolesWithEnd }}
        {{ $endCandidate := time .end_date }}
        {{ if ne (dateFormat "2006" $endCandidate) "0001" }}
        {{ $validEndRoles = $validEndRoles | append . }}
        {{ end }}
        {{ end }}
        {{ $companyStartDisplay := "" }}
        {{ $companyEndDisplay := "" }}

        {{ if gt (len $rolesWithStart) 0 }}
        {{ $sortedStarts := sort $rolesWithStart "start_date" }}
        {{ $startRole := index $sortedStarts 0 }}
        {{ $cStart := time $startRole.start_date }}
        {{ $cSY := dateFormat "2006" $cStart }}
        {{ $cSM := (replaceRE "^0" "" (dateFormat "01" $cStart)) | int }}
        {{ $companyStartDisplay = print (index $monthsNamesCompany (sub $cSM 1)) " " $cSY }}
        {{ else }}
        {{ $fallbackStart := index $first.roles 0 }}
        {{ $companyStartDisplay = $fallbackStart.dates }}
        {{ end }}

        {{ if gt (len $validEndRoles) 0 }}
        {{ $sortedEnds := sort $validEndRoles "end_date" }}
        {{ $endRole := index $sortedEnds (sub (len $sortedEnds) 1) }}
        {{ $cEnd := time $endRole.end_date }}
        {{ $cEY := dateFormat "2006" $cEnd }}
        {{ $cEM := (replaceRE "^0" "" (dateFormat "01" $cEnd)) | int }}
        {{ $companyEndDisplay = print (index $monthsNamesCompany (sub $cEM 1)) " " $cEY }}
        {{ else }}
        {{ $companyEndDisplay = "Actualidad" }}
        {{ end }}
        <div class="text-sm text-gray-600 dark:text-gray-300 flex items-center gap-2 mt-1">
          <em class="fa fa-calendar"></em>
          <span>{{ $companyStartDisplay }} - {{ $companyEndDisplay }}</span>
        </div>
        {{ end }}
        {{ $firstRolesOdd := eq (mod $firstRolesCount 2) 1 }}
        <div class="p-4 grid grid-cols-2 gap-2">
          {{ range $idx, $role := $first.roles }}
          {{ $spanClass := cond (and $firstRolesOdd (eq $idx 0)) "col-span-2" "" }}
          <div class="background rounded-xl p-3 {{ $spanClass }}">
            <div class="flex flex-col items-start justify-between gap-3">
              <div class="w-full">
                <h4
                  class="text-sm font-semibold text-fuchsia-700 background rounded-xl w-full p-2 text-center mb-2">
                  {{ $role.title }}</h4>
                {{/* Calcular duración para roles del resto de empresas (igual lógica que arriba) */}}
                {{ $monthsNames := slice "enero" "febrero" "marzo" "abril" "mayo" "junio" "julio" "agosto" "septiembre"
                "octubre" "noviembre" "diciembre" }}
                {{ $startDisplay2 := "" }}
                {{ $endDisplay2 := "" }}
                {{ $durationDisplay2 := "" }}
                {{ if $role.start_date }}
                {{ $start2 := time $role.start_date }}
                {{ $sY2 := dateFormat "2006" $start2 }}
                {{ $sM2 := (replaceRE "^0" "" (dateFormat "01" $start2)) | int }}
                {{ $startDisplay2 = print (index $monthsNames (sub $sM2 1)) " " $sY2 }}
                {{ if and $role.end_date (ne $role.end_date "") }}
                {{ $end2 := time $role.end_date }}
                {{ $eY2 := dateFormat "2006" $end2 }}
                {{ $eM2 := (replaceRE "^0" "" (dateFormat "01" $end2)) | int }}
                {{ $endDisplay2 = print (index $monthsNames (sub $eM2 1)) " " $eY2 }}
                {{ else }}
                {{ $end2 := now }}
                {{ $endDisplay2 = "Actualidad" }}
                {{ end }}
        
                {{ $e2 := cond (and $role.end_date (ne $role.end_date "")) (time $role.end_date) (now) }}
                {{ $sY2num := (dateFormat "2006" $start2) | int }}
                {{ $sM2num := (replaceRE "^0" "" (dateFormat "01" $start2)) | int }}
                {{ $e2Ynum := (dateFormat "2006" $e2) | int }}
                {{ $e2Mnum := (replaceRE "^0" "" (dateFormat "01" $e2)) | int }}
        
                {{ $years2 := sub $e2Ynum $sY2num }}
                {{ $months2 := sub $e2Mnum $sM2num }}
                {{ if lt $months2 0 }}
                {{ $years2 = sub $years2 1 }}
                {{ $months2 = add $months2 12 }}
                {{ end }}
        
                {{ $parts2 := slice }}
                {{ if gt $years2 0 }}
                {{ $parts2 = $parts2 | append (print $years2 " años") }}
                {{ end }}
                {{ if gt $months2 0 }}
                {{ $parts2 = $parts2 | append (print $months2 " meses") }}
                {{ end }}
                {{ if eq (len $parts2) 0 }}
                {{ $durationDisplay2 = "menos de un mes" }}
                {{ else }}
                {{ $durationDisplay2 = delimit $parts2 " " }}
                {{ end }}
                {{ else }}
                {{ $startDisplay2 = $role.dates }}
                {{ end }}
        
                <div class="text-xs text-gray-500 dark:text-gray-400">
                  <em class="fa fa-calendar"></em>
                  {{ $startDisplay2 }} - {{ $endDisplay2 }}
                  <br />
                  <em class="fa fa-hourglass-start"></em> {{ $durationDisplay2 }}
                </div>
              </div>
              <div class="hidden md:flex flex-wrap gap-1 items-center justify-center">
                {{ $tl := $techList }}
                {{ range first 4 $role.skills }}
                {{ $skill := . }}
                {{ $match := where $tl "name" $skill }}
                {{ if gt (len $match) 0 }}
                {{ $t := index $match 0 }}
                <span class="flex items-center text-xs px-2 py-0.5 rounded-full background">
                  {{ if $t.image }}<img src="{{ $t.image }}" alt="{{ $t.name }} icon"
                    class="h-4 w-4 mr-1 inline-block object-contain" loading="lazy" decoding="async">{{ end }}
                  {{ $skill }}
                </span>
                {{ else }}
                <span class="text-xs px-2 py-0.5 rounded-full background">{{ $skill }}</span>
                {{ end }}
                {{ end }}
              </div>
            </div>
            {{ if $role.description }}
            <p class="mt-2 text-sm text-gray-700 dark:text-gray-300 line-clamp-3 hidden">{{ $role.description }}</p>
            {{ end }}
          </div>
          {{ end }}
        </div>
      </div>
    </div>


  </article>
</div>

{{ $rest := after 1 $data.positions }}
{{ if gt (len $rest) 0 }}
<section class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-6 gap-2 auto-rows-min grid-flow-dense">
  {{ range $j, $company := $rest }}
  <div class="w-full col-span-1 md:col-span-3">
    <article class="background h-full rounded-xl shadow overflow-hidden flex flex-col">
      <div class="p-4 flex items-center gap-4">
        <img src="{{ $company.company_logo | default " /img/placeholder-company.png" }}"
          alt="{{ $company.company }} logo" class="h-16 w-16 object-contain rounded-xl background"
          loading="lazy" decoding="async">
        <div class="flex-1">
          <h4 class="text-lg font-bold text-fuchsia-700">{{ $company.company }}</h4>
          <div class="text-sm text-gray-600 dark:text-gray-300">
            <em class="fa fa-location-pin"></em> {{ $company.location }}
          </div>
          {{ $companyRolesCount := len $company.roles }}
          {{ if gt $companyRolesCount 0 }}
          {{ $monthsNamesCompany := slice "enero" "febrero" "marzo" "abril" "mayo" "junio" "julio" "agosto" "septiembre" "octubre" "noviembre" "diciembre" }}
          {{ $rolesWithStart := where $company.roles "start_date" "!=" "" }}
          {{ $rolesWithEnd := where $company.roles "end_date" "!=" "" }}
          {{ $validEndRoles := slice }}
          {{ range $rolesWithEnd }}
          {{ $endCandidate := time .end_date }}
          {{ if ne (dateFormat "2006" $endCandidate) "0001" }}
          {{ $validEndRoles = $validEndRoles | append . }}
          {{ end }}
          {{ end }}
          {{ $companyStartDisplay := "" }}
          {{ $companyEndDisplay := "" }}

          {{ if gt (len $rolesWithStart) 0 }}
          {{ $sortedStarts := sort $rolesWithStart "start_date" }}
          {{ $startRole := index $sortedStarts 0 }}
          {{ $cStart := time $startRole.start_date }}
          {{ $cSY := dateFormat "2006" $cStart }}
          {{ $cSM := (replaceRE "^0" "" (dateFormat "01" $cStart)) | int }}
          {{ $companyStartDisplay = print (index $monthsNamesCompany (sub $cSM 1)) " " $cSY }}
          {{ else }}
          {{ $fallbackStart := index $company.roles 0 }}
          {{ $companyStartDisplay = $fallbackStart.dates }}
          {{ end }}

          {{ if gt (len $validEndRoles) 0 }}
          {{ $sortedEnds := sort $validEndRoles "end_date" }}
          {{ $endRole := index $sortedEnds (sub (len $sortedEnds) 1) }}
          {{ $cEnd := time $endRole.end_date }}
          {{ $cEY := dateFormat "2006" $cEnd }}
          {{ $cEM := (replaceRE "^0" "" (dateFormat "01" $cEnd)) | int }}
          {{ $companyEndDisplay = print (index $monthsNamesCompany (sub $cEM 1)) " " $cEY }}
          {{ else }}
          {{ $companyEndDisplay = "Actualidad" }}
          {{ end }}
          <div class="text-sm text-gray-600 dark:text-gray-300 flex items-center gap-2 mt-1">
            <em class="fa fa-calendar"></em>
            <span>{{ $companyStartDisplay }} - {{ $companyEndDisplay }}</span>
          </div>
          {{ end }}
        </div>
      </div>
      {{ $companyRolesOdd := eq (mod $companyRolesCount 2) 1 }}
      <div class="p-4 grid grid-cols-2 gap-2">
        {{ range $idx, $role := $company.roles }}
        {{ $spanClass := cond (and $companyRolesOdd (eq $idx 0)) "col-span-2" "" }}
        <div class="background rounded-xl p-3 {{ $spanClass }}">
          <div class="flex flex-col items-start justify-between gap-3">
            <div class="w-full">
              <h4 class="text-sm font-semibold text-fuchsia-700 background rounded-xl w-full p-2 text-center mb-2">{{ $role.title }}</h4>
              {{/* Calcular duración para roles del resto de empresas (igual lógica que arriba) */}}
              {{ $monthsNames := slice "enero" "febrero" "marzo" "abril" "mayo" "junio" "julio" "agosto" "septiembre"
              "octubre" "noviembre" "diciembre" }}
              {{ $startDisplay2 := "" }}
              {{ $endDisplay2 := "" }}
              {{ $durationDisplay2 := "" }}
              {{ if $role.start_date }}
              {{ $start2 := time $role.start_date }}
              {{ $sY2 := dateFormat "2006" $start2 }}
              {{ $sM2 := (replaceRE "^0" "" (dateFormat "01" $start2)) | int }}
              {{ $startDisplay2 = print (index $monthsNames (sub $sM2 1)) " " $sY2 }}
              {{ if and $role.end_date (ne $role.end_date "") }}
              {{ $end2 := time $role.end_date }}
              {{ $eY2 := dateFormat "2006" $end2 }}
              {{ $eM2 := (replaceRE "^0" "" (dateFormat "01" $end2)) | int }}
              {{ $endDisplay2 = print (index $monthsNames (sub $eM2 1)) " " $eY2 }}
              {{ else }}
              {{ $end2 := now }}
              {{ $endDisplay2 = "Actualidad" }}
              {{ end }}

              {{ $e2 := cond (and $role.end_date (ne $role.end_date "")) (time $role.end_date) (now) }}
              {{ $sY2num := (dateFormat "2006" $start2) | int }}
              {{ $sM2num := (replaceRE "^0" "" (dateFormat "01" $start2)) | int }}
              {{ $e2Ynum := (dateFormat "2006" $e2) | int }}
              {{ $e2Mnum := (replaceRE "^0" "" (dateFormat "01" $e2)) | int }}

              {{ $years2 := sub $e2Ynum $sY2num }}
              {{ $months2 := sub $e2Mnum $sM2num }}
              {{ if lt $months2 0 }}
              {{ $years2 = sub $years2 1 }}
              {{ $months2 = add $months2 12 }}
              {{ end }}

              {{ $parts2 := slice }}
              {{ if gt $years2 0 }}
              {{ $parts2 = $parts2 | append (print $years2 " años") }}
              {{ end }}
              {{ if gt $months2 0 }}
              {{ $parts2 = $parts2 | append (print $months2 " meses") }}
              {{ end }}
              {{ if eq (len $parts2) 0 }}
              {{ $durationDisplay2 = "menos de un mes" }}
              {{ else }}
              {{ $durationDisplay2 = delimit $parts2 " " }}
              {{ end }}
              {{ else }}
              {{ $startDisplay2 = $role.dates }}
              {{ end }}

              <div class="text-xs text-gray-500 dark:text-gray-400">
                <em class="fa fa-calendar"></em>
                {{ $startDisplay2 }} - {{ $endDisplay2 }} 
                <br />
                <em class="fa fa-hourglass-start"></em> {{ $durationDisplay2 }}
              </div>
            </div>
            <div class="hidden md:flex flex-wrap gap-1 items-center justify-center">
              {{ $tl := $techList }}
              {{ range first 4 $role.skills }}
              {{ $skill := . }}
              {{ $match := where $tl "name" $skill }}
              {{ if gt (len $match) 0 }}
              {{ $t := index $match 0 }}
              <span class="flex items-center text-xs px-2 py-0.5 rounded-full background">
                {{ if $t.image }}<img src="{{ $t.image }}" alt="{{ $t.name }} icon" class="h-4 w-4 mr-1 inline-block object-contain" loading="lazy" decoding="async">{{ end }}
                {{ $skill }}
              </span>
              {{ else }}
              <span class="text-xs px-2 py-0.5 rounded-full background">{{ $skill }}</span>
              {{ end }}
              {{ end }}
            </div>
          </div>
          {{ if $role.description }}
          <p class="mt-2 text-sm text-gray-700 dark:text-gray-300 line-clamp-3 hidden">{{ $role.description }}</p>
          {{ end }}
        </div>
        {{ end }}
      </div>
    </article>
  </div>
  {{ end }}
</section>
{{ end }}
{{ end }}